# МЕТРИКИ КАЧЕСТВА И КРИТЕРИИ ПРИЕМКИ

**Автор**: Yan Bubenok
**Email**: yan@bubenok.com
**Telegram**: @iBubenok

**Версия**: 1.0
**Дата**: 2025-11-14
**Статус**: Утверждено

---

## 1. МЕТРИКИ КОРРЕКТНОСТИ

### 1.1 Потеря сообщений
- **Метрика**: `messages_lost = messages_produced - messages_delivered`
- **Целевое значение**: `0` (ноль потерь)
- **Критичность**: Блокирующая
- **Способ измерения**: Атомарные счетчики в SystemStatistics

### 1.2 Нарушения порядка
- **Метрика**: `order_violations` для каждого (producer_id, msg_type)
- **Целевое значение**: `0` (нулевые нарушения)
- **Критичность**: Блокирующая
- **Способ измерения**: OrderTracker в каждой Strategy

### 1.3 Успешность тестовых сценариев
- **Метрика**: Количество пройденных сценариев из 6
- **Целевое значение**: `6/6` (100%)
- **Сценарии**:
  1. Baseline: Базовая нагрузка
  2. Hot Type: Hotspot 70%
  3. Burst Pattern: Всплески нагрузки
  4. Imbalanced Processing: Неравномерная обработка
  5. Ordering Stress: Экстремальная конкуренция
  6. Strategy Bottleneck: Узкое место

---

## 2. МЕТРИКИ ПРОИЗВОДИТЕЛЬНОСТИ

### 2.1 Пропускная способность
- **Метрика**: Сообщений в секунду (msgs/sec)
- **Целевое значение**: ≥ 10,000,000 msgs/sec
- **Измерение**: `total_delivered / duration_secs`
- **Условия**: Baseline сценарий, 4 производителя

### 2.2 End-to-End задержка
| Перцентиль | Целевое значение | Критичность |
|------------|------------------|-------------|
| p50 | < 1.0 μs | Желательно |
| p90 | < 2.0 μs | Желательно |
| p99 | < 5.0 μs | Обязательно |
| p99.9 | < 10.0 μs | Желательно |
| max | < 50.0 μs | Допустимо |

### 2.3 Задержки по стадиям
| Стадия | p99 Target | Примечание |
|--------|-----------|------------|
| Stage1 Router | < 1.0 μs | Overhead маршрутизации |
| Processing | Variable | Зависит от конфигурации |
| Stage2 Router | < 1.0 μs | Overhead маршрутизации |

### 2.4 Масштабируемость
- **Метрика**: Speedup при увеличении производителей
- **Целевые значения**:
  - 1 → 2 producers: Speedup ≥ 1.8×
  - 2 → 4 producers: Speedup ≥ 1.8×
  - 4 → 8 producers: Speedup ≥ 1.5×
- **Примечание**: Деградация из-за Stage1 Router bottleneck

---

## 3. МЕТРИКИ КАЧЕСТВА КОДА

### 3.1 Статический анализ
- **Compiler warnings**: 0 warnings с `-Wall -Wextra -Wpedantic`
- **Thread Sanitizer**: 0 data races
- **Address Sanitizer**: 0 memory leaks
- **UB Sanitizer**: 0 undefined behaviors

### 3.2 Покрытие документацией
| Компонент | Требование |
|-----------|-----------|
| Lock-free операции | Memory ordering обоснование |
| Сложные алгоритмы | Псевдокод или описание |
| Публичные API | Документация параметров |
| Критические инварианты | Явное указание |

### 3.3 Стиль кода
- **Naming conventions**: snake_case для переменных, PascalCase для классов
- **File organization**: Разделение на include/ и src/
- **Header guards**: `#pragma once`
- **Const correctness**: Где применимо

---

## 4. КРИТЕРИИ ПРИЕМКИ

### 4.1 Корректность (40%)
**Обязательные критерии (все должны быть выполнены):**
- ✅ Нулевая потеря сообщений во всех 6 сценариях
- ✅ Нулевые ordering violations во всех сценариях
- ✅ Все 6 тестовых сценариев завершаются с PASSED
- ✅ Финальная валидация `validate()` возвращает `true`

**Вес**: 40% от общей оценки
**Критичность**: Блокирующая (если не выполнено, проект не принимается)

### 4.2 Производительность (30%)
**Целевые метрики:**
- ✅ Пропускная способность ≥ 10M msgs/sec (baseline)
- ✅ End-to-end latency p99 < 5 μs
- ✅ Эффективное использование CPU (~100% на активных ядрах)
- ✅ Линейное масштабирование до 4 производителей

**Оценка**:
- 30/30: Все метрики достигнуты
- 20/30: 3 из 4 метрик достигнуты
- 10/30: 2 из 4 метрик достигнуты
- 0/30: Менее 2 метрик

### 4.3 Качество кода (20%)
**Критерии:**
- ✅ Чистый, читаемый код с понятной структурой (5 баллов)
- ✅ Корректная обработка ошибок и edge cases (5 баллов)
- ✅ Правильное использование memory ordering (5 баллов)
- ✅ Отсутствие data races, memory leaks, UB (5 баллов)

**Оценка**: Сумма баллов по критериям

### 4.4 Анализ и документация (10%)
**Критерии:**
- ✅ Понимание узких мест системы (2 балла)
- ✅ Качественные измерения производительности (2 балла)
- ✅ Инсайты в REPORT.md (2 балла)
- ✅ Объяснение trade-offs (2 балла)
- ✅ Полная документация (README, ARCHITECTURE) (2 балла)

**Оценка**: Сумма баллов

---

## 5. ПРОЦЕДУРА ВАЛИДАЦИИ

### 5.1 Автоматическая валидация
```bash
# Сборка Docker образа
docker-compose build

# Запуск всех тестовых сценариев
for config in configs/*.json; do
    docker-compose run router-test $config
    if [ $? -ne 0 ]; then
        echo "FAILED: $config"
        exit 1
    fi
done

# Запуск всех бенчмарков
docker-compose run all-benchmarks

# Проверка результатов
python scripts/validate_results.py results/
```

### 5.2 Ручная валидация
1. **Code review**: Проверка качества кода, комментариев, memory ordering
2. **Performance analysis**: Анализ профилей производительности
3. **Documentation review**: Проверка полноты и актуальности документации
4. **Architecture assessment**: Соответствие архитектурным принципам

---

## 6. МЕТРИКИ ДЛЯ БЕНЧМАРКОВ

### 6.1 Queue Benchmark
- **Throughput**: ≥ 20M msgs/sec для SPSC очереди в изоляции
- **Push latency**: < 50ns (p99)
- **Pop latency**: < 50ns (p99)
- **Round-trip latency**: < 100ns (p99)

### 6.2 Routing Benchmark
- **Stage1 overhead**: < 200ns (среднее)
- **Stage2 overhead**: < 200ns (среднее)
- **Total routing overhead**: < 400ns vs прямая передача

### 6.3 Memory Benchmark
- **Steady-state allocations**: 0 (все pre-allocated)
- **Memory usage**: < 150MB для baseline конфигурации
- **Queue utilization**: Average depth < 50% capacity

### 6.4 Scaling Benchmark
- **1 producer**: Baseline throughput T₀
- **2 producers**: ≥ 1.8 × T₀
- **4 producers**: ≥ 3.5 × T₀
- **8 producers**: ≥ 6.0 × T₀

---

**Конец документа**
