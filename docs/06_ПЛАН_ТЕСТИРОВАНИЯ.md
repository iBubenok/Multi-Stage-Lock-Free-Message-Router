# ПЛАН ТЕСТИРОВАНИЯ

**Автор**: Yan Bubenok
**Email**: yan@bubenok.com
**Telegram**: @iBubenok

**Версия**: 1.0
**Дата**: 2025-11-14
**Статус**: Утверждено

---

## 1. ТЕСТОВЫЕ СЦЕНАРИИ

### Сценарий 1: Baseline (10 секунд)
**Цель**: Проверка базовой функциональности при равномерной нагрузке.

**Конфигурация**:
- Производители: 4 × 1M msgs/sec = 4M msgs/sec total
- Распределение: 25% каждого типа (0-3)
- Процессоры: 4, по 100ns обработки
- Стратегии: 3

**Ожидаемые результаты**:
- Produced: 40,000,000
- Delivered: 40,000,000
- Lost: 0
- Ordering violations: 0
- End-to-end latency p99: < 5μs

---

### Сценарий 2: Hot Type (15 секунд)
**Цель**: Проверка обработки несбалансированной нагрузки.

**Конфигурация**:
- Hotspot: 70% сообщений типа-0
- Остальные типы: по 10%
- Процессор-0 получает 70% нагрузки

**Ожидаемые результаты**:
- Система справляется без деградации
- Processor-0 queue depth выше остальных
- Нет потерь и нарушений порядка

---

### Сценарий 3: Burst Pattern (20 секунд)
**Цель**: Проверка обработки всплесков нагрузки.

**Паттерн** (каждые 2 секунды):
- 200ms burst: 5× скорость (20M msgs/sec)
- 1800ms quiet: 0.5× скорость (2M msgs/sec)

**Ожидаемые результаты**:
- Очереди буферизуют bursts
- Нет overflow и потерь
- Queue depths пульсируют

---

### Сценарий 4: Imbalanced Processing (15 секунд)
**Цель**: Проверка работы при разном времени обработки.

**Время обработки**:
- Type-0: 50ns (быстро)
- Type-1: 500ns (средне)
- Type-2: 2000ns (медленно — bottleneck)
- Type-3: 100ns (быстро)

**Ожидаемые результаты**:
- Processor-2 загружен на 100%
- Backpressure на producer-2
- Остальные процессоры не блокируются

---

### Сценарий 5: Ordering Stress (10 секунд)
**Цель**: Экстремальная проверка сохранения порядка.

**Конфигурация**:
- Все 4 производителя отправляют только type-0
- Все идут через один Processor-0
- Далее к одной Strategy-0
- 8M msgs/sec через одно узкое место

**Ожидаемые результаты**:
- Идеальный порядок (0 violations)
- Processor-0 queue высокая загрузка
- Все сообщения доставлены

---

### Сценарий 6: Strategy Bottleneck (20 секунд)
**Цель**: Проверка backpressure при медленной стратегии.

**Конфигурация**:
- Strategy-0: 1000ns обработки (медленно)
- Strategy-1, Strategy-2: 50ns (быстро)

**Ожидаемые результаты**:
- Strategy-0 queue заполнена
- Backpressure распространяется назад
- Нет потерь сообщений
- Natural flow control работает

---

## 2. БЕНЧМАРКИ

### 2.1 Queue Benchmark
**Тесты**:
1. `BM_SPSCQueue_Throughput`: Пропускная способность
2. `BM_SPSCQueue_Latency`: Push/Pop latency
3. `BM_SPSCQueue_Contention`: High contention scenarios

**Варианты**: Capacity 4K, 16K, 64K

---

### 2.2 Routing Benchmark
**Тесты**:
1. `BM_Stage1Router_Overhead`: Overhead vs прямая передача
2. `BM_Stage2Router_Overhead`: Overhead маршрутизации
3. `BM_RoundRobin_Fairness`: Балансировка нагрузки

---

### 2.3 Memory Benchmark
**Тесты**:
1. `BM_Memory_SteadyState`: Allocations в steady state
2. `BM_Memory_QueueUsage`: Использование памяти очередей
3. `BM_Memory_MessageSize`: Влияние размера Message

---

### 2.4 Scaling Benchmark
**Тесты**:
1. `BM_Scaling_Producers`: 1, 2, 4, 8 производителей
2. `BM_Scaling_Processors`: 1, 2, 4, 8 процессоров
3. `BM_Scaling_Bottleneck`: Выявление узких мест

---

## 3. ПРОЦЕДУРА ТЕСТИРОВАНИЯ

### 3.1 Подготовка окружения
```bash
# Установка CPU governor
echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# Сборка Docker образа
docker-compose build

# Создание директории для результатов
mkdir -p results/benchmarks
```

### 3.2 Запуск тестов
```bash
# Все сценарии
./scripts/docker_run_all.sh

# Конкретный сценарий
docker-compose run router-test configs/baseline.json

# Все бенчмарки
docker-compose run all-benchmarks
```

### 3.3 Анализ результатов
```bash
# Просмотр summary
cat results/baseline_summary.txt

# Просмотр benchmark JSON
cat results/benchmarks/queue_benchmark.json | jq '.benchmarks'

# Проверка валидации
grep "Test Result:" results/*.txt
```

---

## 4. ЧЕКЛИСТ ВАЛИДАЦИИ

### 4.1 Функциональные тесты
- [ ] Все 6 сценариев завершаются с PASSED
- [ ] Нулевые потери во всех сценариях
- [ ] Нулевые ordering violations
- [ ] Graceful shutdown работает
- [ ] Signal handling (SIGINT) корректен

### 4.2 Производительность
- [ ] Baseline: ≥ 10M msgs/sec
- [ ] Latency p99 < 5μs
- [ ] Бенчмарки достигают целевых значений
- [ ] Масштабирование линейное до 4 producers

### 4.3 Качество кода
- [ ] Компиляция без warnings
- [ ] Thread Sanitizer: 0 data races
- [ ] Address Sanitizer: 0 leaks
- [ ] UB Sanitizer: 0 undefined behaviors

### 4.4 Документация
- [ ] README.md актуален
- [ ] ARCHITECTURE.md полный
- [ ] CLAUDE.md для работы с кодовой базой
- [ ] REPORT.md с результатами

---

**Конец документа**
