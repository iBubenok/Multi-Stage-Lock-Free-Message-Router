# РУКОВОДСТВО РАЗРАБОТЧИКА

**Автор**: Yan Bubenok
**Email**: yan@bubenok.com
**Telegram**: @iBubenok

**Версия**: 1.0
**Дата**: 2025-11-14
**Статус**: Утверждено

---

## 1. БЫСТРЫЙ СТАРТ

### 1.1 Требования
- Docker 20+ и Docker Compose 2+
- (Опционально) Clang 19+, CMake 3.20+ для нативной сборки
- Linux рекомендуется (Ubuntu 22.04+)

### 1.2 Сборка и запуск
```bash
# Клонирование репозитория
git clone <repo-url>
cd message-router

# Сборка Docker образа
docker-compose build

# Запуск baseline теста
docker-compose run router-test configs/baseline.json

# Запуск всех тестов
./scripts/docker_run_all.sh

# Запуск бенчмарков
docker-compose run all-benchmarks

# Просмотр результатов
cat results/baseline_summary.txt
```

---

## 2. СТРУКТУРА ПРОЕКТА

```
message-router/
├── CMakeLists.txt          # Конфигурация сборки
├── Dockerfile              # Multi-stage Docker build
├── docker-compose.yml      # Сервисы для тестирования
├── configs/                # Тестовые конфигурации
│   ├── baseline.json
│   ├── hot_type.json
│   └── ...
├── include/                # Заголовочные файлы
│   ├── message.hpp
│   ├── spsc_queue.hpp
│   ├── router.hpp
│   └── ...
├── src/                    # Исходный код
│   ├── main.cpp
│   ├── core/
│   ├── components/
│   └── utils/
├── benchmarks/             # Google Benchmarks
│   ├── queue_benchmark.cpp
│   └── ...
├── scripts/                # Вспомогательные скрипты
├── results/                # Выходные результаты
└── docs/                   # Документация
```

---

## 3. НАТИВНАЯ СБОРКА

### 3.1 Установка зависимостей (Ubuntu 22.04)
```bash
sudo apt-get update
sudo apt-get install -y \
    build-essential \
    cmake \
    clang-19 \
    libc++-19-dev \
    libc++abi-19-dev \
    git
```

### 3.2 Сборка
```bash
# Release build
mkdir build && cd build
cmake -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_CXX_COMPILER=clang++-19 \
      -DBUILD_BENCHMARKS=ON ..
make -j$(nproc)

# Debug build с sanitizers
mkdir build-debug && cd build-debug
cmake -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_CXX_COMPILER=clang++-19 \
      -DBUILD_BENCHMARKS=OFF ..
make -j$(nproc)
```

### 3.3 Запуск
```bash
# Тест
./router_test ../configs/baseline.json

# Бенчмарк
./queue_benchmark
```

---

## 4. РАЗРАБОТКА НОВЫХ КОМПОНЕНТОВ

### 4.1 Добавление компонента
1. Создать header в `include/`
2. Создать implementation в `src/components/`
3. Добавить в `CMakeLists.txt`
4. Документировать в `ARCHITECTURE.md`

**Шаблон компонента**:
```cpp
// include/my_component.hpp
#pragma once
#include "message.hpp"
#include "spsc_queue.hpp"
#include <atomic>

class MyComponent {
public:
    using InputQueue = SPSCQueue<Message, 65536>;

    MyComponent(params...);
    void run(std::atomic<bool>& running);

private:
    // members
};
```

### 4.2 Добавление бенчмарка
```cpp
// benchmarks/my_benchmark.cpp
#include <benchmark/benchmark.h>
#include "my_component.hpp"

static void BM_MyComponent(benchmark::State& state) {
    // Setup
    for (auto _ : state) {
        // Benchmark code
    }
    state.SetItemsProcessed(state.iterations());
}
BENCHMARK(BM_MyComponent);

BENCHMARK_MAIN();
```

Добавить в `CMakeLists.txt`:
```cmake
add_executable(my_benchmark benchmarks/my_benchmark.cpp)
target_link_libraries(my_benchmark PRIVATE router_core benchmark::benchmark)
```

---

## 5. ОТЛАДКА

### 5.1 Thread Sanitizer
```bash
mkdir build-tsan && cd build-tsan
cmake -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_CXX_FLAGS="-fsanitize=thread" \
      -DCMAKE_CXX_COMPILER=clang++-19 ..
make -j$(nproc)
./router_test ../configs/baseline.json
```

### 5.2 Address Sanitizer
```bash
mkdir build-asan && cd build-asan
cmake -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_CXX_FLAGS="-fsanitize=address" \
      -DCMAKE_CXX_COMPILER=clang++-19 ..
make -j$(nproc)
./router_test ../configs/baseline.json
```

### 5.3 GDB Debugging
```bash
gdb --args ./router_test ../configs/baseline.json
(gdb) break main
(gdb) run
(gdb) bt  # backtrace
```

---

## 6. ПРОФИЛИРОВАНИЕ

### 6.1 perf
```bash
# Запись профиля
perf record -g ./router_test ../configs/baseline.json

# Анализ
perf report

# Flamegraph
perf script | stackcollapse-perf.pl | flamegraph.pl > flamegraph.svg
```

### 6.2 valgrind (cachegrind)
```bash
valgrind --tool=cachegrind ./router_test ../configs/baseline.json
cg_annotate cachegrind.out.<pid>
```

---

## 7. CI/CD

### 7.1 Автоматическое тестирование
```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build Docker
        run: docker-compose build
      - name: Run tests
        run: ./scripts/docker_run_all.sh
      - name: Upload results
        uses: actions/upload-artifact@v2
        with:
          name: test-results
          path: results/
```

### 7.2 Бенчмарки в CI
```bash
# Запуск с фиксированным временем
docker-compose run --rm \
    -e BENCHMARK_MIN_TIME=1.0 \
    queue-benchmark
```

---

## 8. ЛУЧШИЕ ПРАКТИКИ

### 8.1 Lock-Free Код
- Всегда явно указывать memory ordering
- Документировать обоснование выбора ordering
- Использовать `alignas(64)` для предотвращения false sharing
- Проверять Thread Sanitizer'ом

### 8.2 Производительность
- Профилировать перед оптимизацией
- Минимизировать аллокации на hot path
- Использовать битовые операции для модуло степени 2
- Busy-wait с `__builtin_ia32_pause()` для низкой latency

### 8.3 Тестирование
- Запускать все sanitizers перед commit
- Проверять все 6 сценариев
- Измерять производительность после изменений
- Обновлять документацию

---

## 9. TROUBLESHOOTING

### Проблема: High queue depths
**Причина**: Bottleneck в обработке
**Решение**: Профилировать узкое место, увеличить количество процессоров

### Проблема: Message loss
**Причина**: Overflow очередей или race condition
**Решение**: Проверить Thread Sanitizer, увеличить размер очередей

### Проблема: Ordering violations
**Причина**: Round-robin для ordering-critical типов
**Решение**: Проверить stage1_rules — использовать 1:1 маршрутизацию

### Проблема: Low performance
**Причина**: CPU governor на powersave
**Решение**: Установить performance mode

---

**Конец документа**
